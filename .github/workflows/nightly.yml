name: Nightly Comprehensive Tests

on:
  schedule:
    # Run every night at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      run_performance_tests:
        description: 'Run performance tests'
        required: false
        default: 'true'
        type: boolean

jobs:
  comprehensive-test:
    name: Comprehensive Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: 11
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run unit tests
      run: mvn test

    - name: Run integration tests
      run: mvn verify -Dmaven.test.skip.exec=false
      env:
        TESTCONTAINERS_RYUK_DISABLED: false

    - name: Run performance tests
      if: github.event.inputs.run_performance_tests == 'true' || github.event_name == 'schedule'
      run: mvn test -Dgroups=performance
      env:
        TESTCONTAINERS_RYUK_DISABLED: false
        
    - name: Generate comprehensive test report
      run: |
        echo "## Nightly Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Java Version:** $(java -version 2>&1 | head -n 1)" >> $GITHUB_STEP_SUMMARY
        
        # Count test results
        if [ -d "target/surefire-reports" ] || [ -d "target/failsafe-reports" ]; then
          TOTAL_TESTS=$(find target/surefire-reports target/failsafe-reports -name "*.xml" 2>/dev/null -exec grep -h "tests=" {} \; | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{sum+=$1} END {print sum}')
          FAILED_TESTS=$(find target/surefire-reports target/failsafe-reports -name "*.xml" 2>/dev/null -exec grep -h "failures=" {} \; | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{sum+=$1} END {print sum}')
          ERROR_TESTS=$(find target/surefire-reports target/failsafe-reports -name "*.xml" 2>/dev/null -exec grep -h "errors=" {} \; | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{sum+=$1} END {print sum}')
          
          echo "- **Total Tests:** ${TOTAL_TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed Tests:** ${FAILED_TESTS:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **Error Tests:** ${ERROR_TESTS:-0}" >> $GITHUB_STEP_SUMMARY

          if [ "${FAILED_TESTS:-0}" -eq 0 ] && [ "${ERROR_TESTS:-0}" -eq 0 ]; then
            echo "- **Status:** All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
    - name: Upload comprehensive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nightly-test-results-${{ github.run_number }}
        path: |
          target/surefire-reports/
          target/failsafe-reports/
          target/site/
        retention-days: 7

  multi-redis-version-test:
    name: Test Against Multiple Redis Versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        redis-version: ['6-alpine', '7-alpine', 'latest']
      fail-fast: false
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: 11
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update Redis version in tests
      run: |
        # Update the Redis image version in test files
        sed -i 's/redis:7-alpine/redis:${{ matrix.redis-version }}/g' src/test/java/org/codarama/redlock4j/integration/RedlockIntegrationTest.java
        sed -i 's/redis:7-alpine/redis:${{ matrix.redis-version }}/g' src/test/java/org/codarama/redlock4j/performance/RedlockPerformanceTest.java
        
    - name: Run integration tests with Redis ${{ matrix.redis-version }}
      run: mvn verify -Dmaven.test.skip.exec=false
      env:
        TESTCONTAINERS_RYUK_DISABLED: false
        
    - name: Report Redis version test results
      run: |
        echo "## Redis ${{ matrix.redis-version }} Test Results" >> $GITHUB_STEP_SUMMARY
        if [ $? -eq 0 ]; then
          echo "Tests passed with Redis ${{ matrix.redis-version }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "Tests failed with Redis ${{ matrix.redis-version }}" >> $GITHUB_STEP_SUMMARY
        fi